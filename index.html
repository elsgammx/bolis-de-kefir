<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <title>Congeladas - Punto de Venta</title>
    <link rel="icon" type="image/png" href="mascota.png" />
    <link rel="apple-touch-icon" href="mascota.png" />
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQ29uZ2VsYWRhcyBQT1MiLCJzaG9ydF9uYW1lIjoiQ29uZ2VsYWRhcyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwidGhlbWVfY29sb3IiOiIjNDI5MmU0IiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZmZmZmYiLCJzdGFydF91cmwiOiIvIiwiaWNvbnMiOlt7InNyYyI6Im1hc2NvdGEucG5nIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3BuZyJ9XX0=" />
    <meta name="theme-color" content="#4292e4" />
    <style>
        /* Tu CSS original sin cambios */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f0f4f8;
            color: #333;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background: white;
            position: relative;
        }

        header {
            background: linear-gradient(135deg, #4292e4 0%, #2563eb 100%);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(66, 146, 228, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .header-logo {
            width: 40px;
            height: 40px;
            object-fit: contain;
        }

        .nav-tabs {
            display: flex;
            background: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 60px;
            z-index: 99;
        }

        .nav-tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            border: none;
            background: white;
            color: #666;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .nav-tab.active {
            color: #4292e4;
            border-bottom: 3px solid #4292e4;
            font-weight: bold;
        }

        .content {
            padding: 1rem;
            min-height: calc(100vh - 120px);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .flavor-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .flavor-card {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
            user-select: none;
        }

        .flavor-card.selected {
            background: linear-gradient(135deg, #4292e4 0%, #2563eb 100%);
            color: white;
            transform: scale(1.05);
            border-color: #1e40af;
        }

        .flavor-name {
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .flavor-quantity {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .quantity-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.3);
            color: inherit;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quantity-btn:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .quantity-display {
            font-size: 1.2rem;
            font-weight: bold;
            min-width: 30px;
        }

        .cart-summary {
            background: #f0f7ff;
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
            box-shadow: 0 2px 5px rgba(66, 146, 228, 0.2);
            border: 1px solid #e3f2fd;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e3f2fd;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            font-size: 1.2rem;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 2px solid #4292e4;
            color: #4292e4;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4292e4 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(66, 146, 228, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66, 146, 228, 0.4);
        }

        .btn-secondary {
            background: #e3f2fd;
            color: #1976d2;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background: #bbdefb;
        }

        .date-input,
        input[type="text"],
        select,
        input[type="number"] {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e3f2fd;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .date-input:focus,
        input[type="text"]:focus,
        select:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #4292e4;
        }

        .stats-card {
            background: linear-gradient(135deg, #4292e4 0%, #2563eb 100%);
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 15px rgba(66, 146, 228, 0.3);
        }

        .stats-card:nth-child(2) {
            background: linear-gradient(135deg, #1e88e5 0%, #1565c0 100%);
        }

        .stats-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }

        .stats-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .report-filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 20px;
            background: #e3f2fd;
            color: #1976d2;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .filter-btn.active {
            background: #4292e4;
            color: white;
        }

        .sales-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .sale-item {
            background: #f0f7ff;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            position: relative;
            border: 1px solid #e3f2fd;
        }

        .sale-date {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .delete-sale {
            position: absolute;
            top: 0.5rem;
            right: 30px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .edit-sale {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
            position: relative;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #666;
        }

        .stock-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: #f0f7ff;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border: 1px solid #e3f2fd;
        }

        .stock-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stock-btn {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 50%;
            background: #4292e4;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .stock-btn:hover {
            background: #2563eb;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #999;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 1rem 2rem;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1001;
        }

        .toast.show {
            opacity: 1;
        }

        /* Configuraci√≥n premium checkbox */
        .premium-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .premium-checkbox label {
            cursor: pointer;
            user-select: none;
        }

        /* Ganancias section */
        #ganancias .gain-item {
            background: #f0f7ff;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border: 1px solid #e3f2fd;
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            color: #1976d2;
            font-size: 1.1rem;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <div class="header-logo">‚òÅÔ∏è</div>
            <h1>Bolis de Kefir</h1>
        </header>

        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('ventas', event)">üõí Ventas</button>
            <button class="nav-tab" onclick="showSection('reportes', event)">üìä Reportes</button>
            <button class="nav-tab" onclick="showSection('stock', event)">üì¶ Stock</button>
            <button class="nav-tab" onclick="showSection('ganancias', event)">üí∞ Ganancias</button>
            <button class="nav-tab" onclick="showSection('config', event)">‚öôÔ∏è Config</button>
            <button class="nav-tab" onclick="showSection('recetas', event)">üìã Recetas</button>
        </nav>

        <div class="content">
            <!-- Secci√≥n de Ventas -->
            <div id="ventas" class="section active">
                <div class="input-group">
                    <label>Fecha de venta:</label>
                    <input type="date" id="saleDate" class="date-input" />
                </div>

                <div class="input-group">
                    <label>Cliente:</label>
                    <input type="text" id="clientName" placeholder="Nombre del cliente (opcional)" />
                </div>

                <div class="input-group">
                    <label>Tipo de pago:</label>
                    <select id="paymentType">
                        <option value="Efectivo">Efectivo</option>
                        <option value="Transferencia">Transferencia</option>
                        <option value="Debe">Debe</option>
                    </select>
                </div>

                <h3 style="margin-bottom: 1rem; color: #1976d2;">Selecciona los sabores:</h3>
                <div id="flavorGrid" class="flavor-grid"></div>

                <div id="cartSummary" class="cart-summary" style="display: none;">
                    <h3 style="margin-bottom: 0.5rem; color: #1976d2;">Resumen de venta:</h3>
                    <div id="cartItems"></div>
                    <div class="total-row">
                        <span>Total:</span>
                        <span id="totalAmount">$0</span>
                    </div>
                </div>

                <button class="btn-primary" onclick="completeSale()">Completar Venta</button>
            </div>

            <!-- Secci√≥n de Reportes -->
<div id="reportes" class="section">
    <div class="report-filters">
        <button class="filter-btn active" onclick="filterReport('today', event)">Hoy</button>
        <button class="filter-btn" onclick="filterReport('week', event)">Semana</button>
        <button class="filter-btn" onclick="filterReport('month', event)">Mes</button>
        <button class="filter-btn" onclick="filterReport('all', event)">Todo</button>
    </div>

    <div class="input-group">
        <label>Fecha de inicio:</label>
        <input type="date" id="startDate" />
    </div>
    <div class="input-group">
        <label>Fecha de fin:</label>
        <input type="date" id="endDate" />
    </div>
    <button class="btn-secondary" onclick="filterCustomReport()">Filtrar Personalizado</button>

    <div class="stats-card">
        <div class="stats-label">Ventas totales</div>
        <div class="stats-value" id="totalSales">0</div>
    </div>

    <div class="stats-card">
        <div class="stats-label">Ingresos totales</div>
        <div class="stats-value" id="totalRevenue">$0</div>
    </div>

    <h3 style="margin: 1rem 0; color: #1976d2;">Sabores m√°s vendidos:</h3>
    <div id="topFlavors"></div>

    <h3 style="margin: 1rem 0; color: #1976d2;">Historial de ventas:</h3>
    <div id="salesHistory" class="sales-list"></div>

    <button class="btn-primary" onclick="exportReport()">üì• Exportar Reporte</button>
</div>  

            <!-- Secci√≥n de Stock -->
            <div id="stock" class="section">
                <h3 style="margin-bottom: 1rem; color: #1976d2;">Control de inventario:</h3>
                <div id="stockList"></div>
            </div>

            <!-- Secci√≥n de Ganancias -->
            <div id="ganancias" class="section">
                <h3 style="margin-bottom: 1rem; color: #1976d2;">Ganancias semanales</h3>
                <div id="gainList">
                    <div class="gain-item"><span>Apoyo (10%)</span><span id="gainApoyo">$0</span></div>
                    <div class="gain-item"><span>Crecimiento (20%)</span><span id="gainCrecimiento">$0</span></div>
                    <div class="gain-item"><span>Reinversi√≥n (50%)</span><span id="gainReinversion">$0</span></div>
                    <div class="gain-item"><span>Ganancia (20%)</span><span id="gainGanancia">$0</span></div>
                </div>
            </div>

            <!-- Secci√≥n de Configuraci√≥n -->
            <div id="config" class="section">
                <h3 style="margin-bottom: 1rem; color: #1976d2;">Configuraci√≥n:</h3>

                <div style="margin-bottom: 2rem;">
                    <h4 style="margin-bottom: 0.5rem; color: #1976d2;">Agregar nuevo sabor:</h4>
                    <div class="input-group">
                        <input type="text" id="newFlavorName" placeholder="Nombre del sabor" />
                    </div>
                    <button class="btn-secondary" onclick="addNewFlavor()">+ Agregar Sabor</button>
                </div>

                <div style="margin-bottom: 2rem;">
                    <h4 style="margin-bottom: 0.5rem; color: #1976d2;">Marcar sabores premium:</h4>
                    <div id="premiumList"></div>
                </div>

                <div style="margin-bottom: 2rem;">
                    <h4 style="margin-bottom: 0.5rem; color: #1976d2;">Costos de producci√≥n:</h4>
                    <button class="btn-secondary" onclick="showCostModal()">üí∞ Gestionar Costos</button>
                </div>

                <div style="margin-bottom: 2rem;">
                    <h4 style="margin-bottom: 0.5rem; color: #1976d2;">Informaci√≥n del sistema:</h4>
                    <p style="color: #666; font-size: 0.9rem;">Versi√≥n 1.0 - PWA habilitada</p>
                    <p style="color: #666; font-size: 0.9rem;">Datos almacenados localmente</p>
                </div>
            </div>

            <!-- Secci√≥n de Recetas -->
            <div id="recetas" class="section">
                <h3 style="margin-bottom: 1rem; color: #1976d2;">Recetas de Congeladas</h3>

                <button class="btn-primary" onclick="exportRecipes()">üì• Exportar Recetas</button>

                <div id="recipeList"></div>

                <h4 style="margin-top: 2rem; color: #1976d2;">Agregar / Editar Receta</h4>

                <div class="input-group">
                    <label>Nombre de la congelada:</label>
                    <input type="text" id="recipeName" placeholder="Nombre de la congelada" />
                </div>

                <div class="input-group">
                    <label>Fruta (kg o pz):</label>
                    <input type="number" id="recipeFrutaQty" min="0" step="0.01" />
                    <input type="number" id="recipeFrutaPrice" min="0" step="0.01" placeholder="Precio por kg o pz" />
                </div>
                <div class="input-group">
                    <label>Kefir (litro):</label>
                    <input type="number" id="recipeKefirQty" min="0" step="0.01" />
                    <input type="number" id="recipeKefirPrice" min="0" step="0.01" placeholder="Precio por litro" />
                </div>
                <div class="input-group">
                    <label>Lechera (pieza):</label>
                    <input type="number" id="recipeLecheraQty" min="0" step="1" />
                    <input type="number" id="recipeLecheraPrice" min="0" step="0.01" placeholder="Precio por pieza" />
                </div>
                <div class="input-group">
                    <label>Saborizante (ml):</label>
                    <input type="number" id="recipeSaborizanteQty" min="0" step="0.01" />
                    <input type="number" id="recipeSaborizantePrice" min="0" step="0.01" placeholder="Precio por ml" />
                </div>
                <div class="input-group">
                    <label>Bolsas (pieza):</label>
                    <input type="number" id="recipeBolsasQty" min="0" step="1" />
                    <input type="number" id="recipeBolsasPrice" min="0" step="0.01" placeholder="Precio por pieza" />
                </div>
                <div class="input-group">
                    <label>Trozos (pieza):</label>
                    <input type="number" id="recipeTrozosQty" min="0" step="1" />
                    <input type="number" id="recipeTrozosPrice" min="0" step="0.01" placeholder="Precio por pieza" />
                </div>

                <div class="input-group">
                    <label>Costo unitario por pieza (calculado):</label>
                    <input type="text" id="unitCost" readonly style="background:#e3f2fd; font-weight:bold;" />
                </div>

                <button class="btn-primary" onclick="saveRecipe()">Guardar Receta</button>
                <button class="btn-secondary" onclick="clearRecipeForm()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal para costos -->
    <div id="costModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 1rem; color: #1976d2;">Gesti√≥n de costos</h3>
            <div id="costList"></div>
            <button class="btn-primary" onclick="closeCostModal()">Cerrar</button>
        </div>
    </div>

    <!-- Modal para editar venta -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 1rem; color: #1976d2;">Editar Venta</h3>

            <div class="input-group">
                <label>Fecha de venta:</label>
                <input type="date" id="editSaleDate" class="date-input" />
            </div>

            <div class="input-group">
                <label>Cliente:</label>
                <input type="text" id="editClientName" placeholder="Nombre del cliente (opcional)" />
            </div>

            <div class="input-group">
                <label>Tipo de pago:</label>
                <select id="editPaymentType">
                    <option value="Efectivo">Efectivo</option>
                    <option value="Transferencia">Transferencia</option>
                    <option value="Debe">Debe</option>
                </select>
            </div>

            <h4 style="margin-bottom: 0.5rem; color: #1976d2;">Sabores:</h4>
            <div id="editFlavorList"></div>

            <button class="btn-primary" onclick="saveEditedSale()">Guardar Cambios</button>
            <button class="btn-secondary" onclick="closeEditModal()">Cancelar</button>
        </div>
    </div>

    <!-- Toast notifications -->
    <div id="toast" class="toast"></div>

    <script>
        // Estado de la aplicaci√≥n
        let appState = {
            flavors: [
                { name: "cereza", premium: false },
                { name: "chocolate hershey", premium: false },
                { name: "chocolate abuelita", premium: false },
                { name: "ciruela", premium: false },
                { name: "coco", premium: false },
                { name: "durazno", premium: false },
                { name: "fresa", premium: false },
                { name: "fresa con nutella", premium: true },
                { name: "guayaba", premium: false },
                { name: "mamey", premium: false },
                { name: "mango", premium: false },
                { name: "mazap√°n", premium: false },
                { name: "nuez", premium: false },
                { name: "oreo", premium: false },
                { name: "pi√±√≥n", premium: false },
                { name: "pistache", premium: false },
            ],
            cart: {},
            sales: [],
            stock: {},
            costs: {},
            currentFilter: "today",
            recipes: [],
            editingRecipeId: null,
        };

        // Obtener fecha local en formato YYYY-MM-DD
        function getLocalDateString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Inicializar la app
        function initApp() {
            loadData();
            setDefaultDate();
            renderFlavors();
            renderStock();
            updateReports();
            renderPremiumList();
            updateGains();
            renderRecipes();
            assignRecipeInputEvents();
        }

        // Cargar datos del localStorage
        function loadData() {
            const savedData = localStorage.getItem("congeladasApp");
            if (savedData) {
                const parsed = JSON.parse(savedData);
                appState = { ...appState, ...parsed };
            }

            appState.flavors.forEach((flavor) => {
                if (!appState.stock[flavor.name]) {
                    appState.stock[flavor.name] = 50; // Stock inicial
                }
                if (!appState.costs[flavor.name]) {
                    appState.costs[flavor.name] = 10; // Costo inicial por defecto
                }
            });
        }

        // Guardar datos en localStorage
        function saveData() {
            localStorage.setItem("congeladasApp", JSON.stringify(appState));
        }

        // Establecer fecha por defecto
        function setDefaultDate() {
            const today = getLocalDateString();
            document.getElementById("saleDate").value = today;
        }

        // Cambiar secci√≥n activa
        function showSection(sectionId, event) {
            document.querySelectorAll(".section").forEach((section) => {
                section.classList.remove("active");
            });
            document.querySelectorAll(".nav-tab").forEach((tab) => {
                tab.classList.remove("active");
            });

            document.getElementById(sectionId).classList.add("active");
            if (event) event.currentTarget.classList.add("active");

            if (sectionId === "reportes") {
                updateReports();
            }
            if (sectionId === "ganancias") {
                updateGains();
            }
            if (sectionId === "recetas") {
                renderRecipes();
            }
        }

        // Renderizar sabores
        function renderFlavors() {
            const grid = document.getElementById("flavorGrid");
            grid.innerHTML = "";

            appState.flavors.forEach((flavor) => {
                const quantity = appState.cart[flavor.name] || 0;
                const card = document.createElement("div");
                card.className = `flavor-card ${quantity > 0 ? "selected" : ""}`;
                card.innerHTML = `
                    <div class="flavor-name">${capitalize(flavor.name)}${flavor.premium ? " ‚≠ê" : ""}</div>
                    <div class="flavor-quantity">
                        <button class="quantity-btn" onclick="updateQuantity('${flavor.name}', -1)">-</button>
                        <span class="quantity-display">${quantity}</span>
                        <button class="quantity-btn" onclick="updateQuantity('${flavor.name}', 1)">+</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Actualizar cantidad
        function updateQuantity(flavorName, change) {
            const currentQty = appState.cart[flavorName] || 0;
            const newQty = Math.max(0, currentQty + change);

            if (newQty === 0) {
                delete appState.cart[flavorName];
            } else {
                appState.cart[flavorName] = newQty;
            }

            renderFlavors();
            updateCartSummary();
        }

        // Actualizar resumen del carrito
        function updateCartSummary() {
            const cartItems = document.getElementById("cartItems");
            const cartSummary = document.getElementById("cartSummary");
            const totalAmount = document.getElementById("totalAmount");

            if (Object.keys(appState.cart).length === 0) {
                cartSummary.style.display = "none";
                return;
            }

            cartSummary.style.display = "block";
            cartItems.innerHTML = "";

            let total = 0;

            Object.entries(appState.cart).forEach(([flavorName, qty]) => {
                const flavorObj = appState.flavors.find((f) => f.name === flavorName);
                const price = flavorObj.premium ? 30 : 25; // Precio base
                const subtotal = price * qty;
                total += subtotal;

                const item = document.createElement("div");
                item.className = "cart-item";
                item.innerHTML = `
                    <span>${capitalize(flavorName)}${flavorObj.premium ? " ‚≠ê" : ""} x${qty}</span>
                    <span>$${subtotal}</span>
                `;
                cartItems.appendChild(item);
            });

            totalAmount.textContent = `$${total}`;
        }

        // Completar venta
        function completeSale() {
            if (Object.keys(appState.cart).length === 0) {
                showToast("Agrega al menos una congelada");
                return;
            }

            const saleDate = document.getElementById("saleDate").value;
            const clientName = document.getElementById("clientName").value.trim() || "Cliente no especificado";
            const paymentType = document.getElementById("paymentType").value;

            let total = 0;

            Object.entries(appState.cart).forEach(([flavorName, qty]) => {
                const flavorObj = appState.flavors.find((f) => f.name === flavorName);
                const price = flavorObj.premium ? 30 : 25; // Precio base
                const subtotal = price * qty;
                total += subtotal;
            });

            const sale = {
                id: Date.now(),
                date: saleDate,
                client: clientName,
                paymentType: paymentType,
                items: { ...appState.cart },
                total: total,
            };

            appState.sales.push(sale);
            appState.cart = {};
            document.getElementById("clientName").value = "";

            saveData();
            renderFlavors();
            updateCartSummary();
            renderStock();

            showToast("¬°Venta completada exitosamente!");
        }

        // Filtrar reportes
        function filterReport(period, event) {
            appState.currentFilter = period;
            document.querySelectorAll(".filter-btn").forEach((btn) => {
                btn.classList.remove("active");
            });
            if (event) event.currentTarget.classList.add("active");
            updateReports();
        }

        // Actualizar reportes
        function updateReports() {
            const today = getLocalDateString();

            let filteredSales = appState.sales;

            switch (appState.currentFilter) {
                case "today":
                    filteredSales = appState.sales.filter((sale) => sale.date === today);
                    break;
                case "week":
                    const weekStart = getWeekStart();
                    filteredSales = appState.sales.filter((sale) => {
                        const saleDate = new Date(sale.date);
                        return saleDate >= weekStart;
                    });
                    break;
                case "month":
                    const now = new Date();
                    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    filteredSales = appState.sales.filter((sale) => {
                        const saleDate = new Date(sale.date);
                        return saleDate >= monthStart;
                    });
                    break;
            }

            document.getElementById("totalSales").textContent = filteredSales.length;
            const totalRevenue = filteredSales.reduce((sum, sale) => sum + sale.total, 0);
            document.getElementById("totalRevenue").textContent = `$${totalRevenue}`;

            const flavorCounts = {};
            filteredSales.forEach((sale) => {
                Object.entries(sale.items).forEach(([flavorName, qty]) => {
                    flavorCounts[flavorName] = (flavorCounts[flavorName] || 0) + qty;
                });
            });

            const topFlavors = Object.entries(flavorCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const topFlavorsDiv = document.getElementById("topFlavors");
            topFlavorsDiv.innerHTML = "";

            if (topFlavors.length === 0) {
                topFlavorsDiv.innerHTML = '<div class="empty-state"><p>No hay datos disponibles</p></div>';
            } else {
                topFlavors.forEach(([flavorName, count]) => {
                    const item = document.createElement("div");
                    item.className = "stock-item";
                    const flavorObj = appState.flavors.find((f) => f.name === flavorName);
                    item.innerHTML = `
                        <span>${capitalize(flavorName)}${flavorObj && flavorObj.premium ? " ‚≠ê" : ""}</span>
                        <span style="font-weight: bold; color: #4292e4;">${count} vendidas</span>
                    `;
                    topFlavorsDiv.appendChild(item);
                });
            }

            renderSalesHistory(filteredSales);
        }

        // Renderizar historial de ventas
        function renderSalesHistory(sales) {
            const historyDiv = document.getElementById("salesHistory");
            historyDiv.innerHTML = "";

            if (sales.length === 0) {
                historyDiv.innerHTML = '<div class="empty-state"><p>No hay ventas registradas</p></div>';
                return;
            }

            sales
                .slice()
                .reverse()
                .forEach((sale) => {
                    const saleDiv = document.createElement("div");
                    saleDiv.className = "sale-item";

                    const itemsList = Object.entries(sale.items)
                        .map(([flavorName, qty]) => {
                            const flavorObj = appState.flavors.find((f) => f.name === flavorName);
                            return `${flavorName} x${qty}`;
                        })
                        .join(", ");

                    saleDiv.innerHTML = `
                    <div class="sale-date">${sale.date}</div>
                    <div><strong>Cliente:</strong> ${sale.client}</div>
                    <div>${itemsList}</div>
                    <div style="font-weight: bold; color: #4292e4;">Total: $${sale.total}</div>
                    <button class="delete-sale" onclick="deleteSale(${sale.id})">√ó</button>
                    <button class="edit-sale" onclick="editSale(${sale.id})">‚úé</button>
                `;
                    historyDiv.appendChild(saleDiv);
                });
        }

        // Eliminar venta
        function deleteSale(saleId) {
            const saleIndex = appState.sales.findIndex((s) => s.id === saleId);
            if (saleIndex !== -1) {
                appState.sales.splice(saleIndex, 1);
                saveData();
                updateReports();
                renderStock();
                showToast("Venta eliminada");
            }
        }

        // Funci√≥n para editar venta
        function editSale(saleId) {
            const sale = appState.sales.find((s) => s.id === saleId);
            if (!sale) return;

            showEditModal(sale);
        }

        // Mostrar modal de edici√≥n
        function showEditModal(sale) {
            const modal = document.getElementById("editModal");
            modal.dataset.saleId = sale.id;

            document.getElementById("editSaleDate").value = sale.date;
            document.getElementById("editClientName").value = sale.client;
            document.getElementById("editPaymentType").value = sale.paymentType;

            const flavorList = document.getElementById("editFlavorList");
            flavorList.innerHTML = "";

            appState.flavors.forEach((flavor) => {
                const qty = sale.items[flavor.name] || 0;
                const div = document.createElement("div");
                div.className = "stock-item";
                div.innerHTML = `
                    <span>${capitalize(flavor.name)}${flavor.premium ? " ‚≠ê" : ""}</span>
                    <div class="stock-controls">
                        <button class="stock-btn" onclick="updateEditQuantity('${flavor.name}', ${sale.id}, -1)">-</button>
                        <span style="margin: 0 1rem; font-weight: bold;">${qty}</span>
                        <button class="stock-btn" onclick="updateEditQuantity('${flavor.name}', ${sale.id}, 1)">+</button>
                    </div>
                `;
                flavorList.appendChild(div);
            });

            modal.classList.add("active");
        }

        // Cerrar modal de edici√≥n
        function closeEditModal() {
            document.getElementById("editModal").classList.remove("active");
        }

        // Actualizar cantidad en modal de edici√≥n
        function updateEditQuantity(flavorName, saleId, change) {
            const sale = appState.sales.find((s) => s.id === saleId);
            if (!sale) return;

            const currentQty = sale.items[flavorName] || 0;
            const newQty = Math.max(0, currentQty + change);

            if (newQty === 0) {
                delete sale.items[flavorName];
            } else {
                sale.items[flavorName] = newQty;
            }

            showEditModal(sale);
        }

        // Guardar cambios de venta editada
        function saveEditedSale() {
            const modal = document.getElementById("editModal");
            const saleId = parseInt(modal.dataset.saleId);
            const sale = appState.sales.find((s) => s.id === saleId);
            if (!sale) return;

            sale.date = document.getElementById("editSaleDate").value;
            sale.client = document.getElementById("editClientName").value.trim() || "Cliente no especificado";
            sale.paymentType = document.getElementById("editPaymentType").value;

            let total = 0;

            Object.entries(sale.items).forEach(([flavorName, qty]) => {
                const flavorObj = appState.flavors.find((f) => f.name === flavorName);
                const price = flavorObj.premium ? 30 : 25; // Precio base
                total += price * qty;
            });

            sale.total = total;

            saveData();
            updateReports();
            closeEditModal();
            showToast("Venta actualizada correctamente");
        }

        // Actualizar ganancias semanales
        function updateGains() {
            const monday = getWeekStart();
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            sunday.setHours(23, 59, 59, 999);

            const weeklySales = appState.sales.filter((sale) => {
                const saleDate = new Date(sale.date);
                return saleDate >= monday && saleDate <= sunday;
            });

            const totalWeeklyRevenue = weeklySales.reduce((sum, sale) => sum + sale.total, 0);

            const apoyo = totalWeeklyRevenue * 0.1;
            const crecimiento = totalWeeklyRevenue * 0.2;
            const reinversion = totalWeeklyRevenue * 0.5;
            const ganancia = totalWeeklyRevenue * 0.2;

            document.getElementById("gainApoyo").textContent = `$${apoyo.toFixed(2)}`;
            document.getElementById("gainCrecimiento").textContent = `$${crecimiento.toFixed(2)}`;
            document.getElementById("gainReinversion").textContent = `$${reinversion.toFixed(2)}`;
            document.getElementById("gainGanancia").textContent = `$${ganancia.toFixed(2)}`;
        }

        // Renderizar lista para marcar premium
        function renderPremiumList() {
            const premiumList = document.getElementById("premiumList");
            premiumList.innerHTML = "";

            appState.flavors.forEach((flavor, index) => {
                const div = document.createElement("div");
                div.className = "premium-checkbox";
                div.innerHTML = `
                    <input type="checkbox" id="premium_${index}" ${flavor.premium ? "checked" : ""} onchange="togglePremium(${index})" />
                    <label for="premium_${index}">${capitalize(flavor.name)}</label>
                `;
                premiumList.appendChild(div);
            });
        }

        // Cambiar estado premium
        function togglePremium(index) {
            appState.flavors[index].premium = !appState.flavors[index].premium;
            saveData();
            renderFlavors();
            renderStock();
            updateCartSummary();
            updateReports();
            renderPremiumList();
        }

        // Renderizar stock
        function renderStock() {
            const stockList = document.getElementById("stockList");
            stockList.innerHTML = "";

            appState.flavors.forEach((flavor) => {
                const stock = appState.stock[flavor.name] || 0;
                const item = document.createElement("div");
                item.className = "stock-item";
                item.innerHTML = `
                    <span>${capitalize(flavor.name)}${flavor.premium ? " ‚≠ê" : ""}</span>
                    <div class="stock-controls">
                        <button class="stock-btn" onclick="updateStock('${flavor.name}', -1)">-</button>
                        <span style="margin: 0 1rem; font-weight: bold;">${stock}</span>
                        <button class="stock-btn" onclick="updateStock('${flavor.name}', 1)">+</button>
                    </div>
                `;
                stockList.appendChild(item);
            });
        }

        // Actualizar stock
        function updateStock(flavorName, change) {
            appState.stock[flavorName] = Math.max(0, (appState.stock[flavorName] || 0) + change);
            saveData();
            renderStock();
        }

        // Agregar nuevo sabor
        function addNewFlavor() {
            const input = document.getElementById("newFlavorName");
            const flavorName = input.value.trim().toLowerCase();

            if (!flavorName) {
                showToast("Ingresa un nombre de sabor");
                return;
            }

            if (appState.flavors.find((f) => f.name === flavorName)) {
                showToast("Este sabor ya existe");
                return;
            }

            appState.flavors.push({ name: flavorName, premium: false });
            appState.stock[flavorName] = 0;
            appState.costs[flavorName] = 10;

            saveData();
            renderFlavors();
            renderStock();
            renderPremiumList();

            input.value = "";
            showToast("Sabor agregado exitosamente");
        }

        // Mostrar modal de costos
        function showCostModal() {
            const modal = document.getElementById("costModal");
            const costList = document.getElementById("costList");

            costList.innerHTML = "";

            appState.flavors.forEach((flavor) => {
                const cost = appState.costs[flavor.name] || 0;
                const div = document.createElement("div");
                div.className = "input-group";
                div.innerHTML = `
                    <label>${capitalize(flavor.name)} - Costo unitario:</label>
                    <input type="number" value="${cost}" onchange="updateCost('${flavor.name}', this.value)" min="0" step="0.01" />
                `;
                costList.appendChild(div);
            });

            modal.classList.add("active");
        }

        // Actualizar costo
        function updateCost(flavorName, value) {
            appState.costs[flavorName] = parseFloat(value) || 0;
            saveData();
        }

        // Cerrar modal de costos
        function closeCostModal() {
            document.getElementById("costModal").classList.remove("active");
        }

        // Exportar reporte
        function exportReport() {
            const reportData = {
                fecha: getLocalDateString(),
                periodo: appState.currentFilter,
                ventas: appState.sales,
                resumen: {
                    totalVentas: appState.sales.length,
                    totalIngresos: appState.sales.reduce((sum, sale) => sum + sale.total, 0),
                    topSabores: {},
                },
            };

            appState.sales.forEach((sale) => {
                Object.entries(sale.items).forEach(([flavorName, qty]) => {
                    reportData.resumen.topSabores[flavorName] =
                        (reportData.resumen.topSabores[flavorName] || 0) + qty;
                });
            });

            let csv = "Reporte de Ventas - Congeladas\n";
            csv += `Fecha del reporte: ${reportData.fecha}\n`;
            csv += `Periodo: ${reportData.periodo}\n\n`;
            csv += `Total de ventas: ${reportData.resumen.totalVentas}\n`;
            csv += `Ingresos totales: $${reportData.resumen.totalIngresos}\n\n`;
            csv += "Sabores m√°s vendidos:\n";

            Object.entries(reportData.resumen.topSabores)
                .sort((a, b) => b[1] - a[1])
                .forEach(([flavorName, count]) => {
                    csv += `${flavorName}: ${count} unidades\n`;
                });

            csv += "\nDetalle de ventas:\n";
            csv += "Fecha,Cliente,Tipo de Pago,Sabores,Total\n";

            appState.sales.forEach((sale) => {
                const items = Object.entries(sale.items)
                    .map(([f, q]) => `${f} x${q}`)
                    .join(" | ");
                csv += `${sale.date},"${sale.client}","${sale.paymentType}","${items}",$${sale.total}\n`;
            });

            const blob = new Blob([csv], { type: "text/csv" });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `reporte_congeladas_${getLocalDateString()}.csv`;
            a.click();

            showToast("Reporte exportado exitosamente");
        }

        // Mostrar toast
        function showToast(message) {
            const toast = document.getElementById("toast");
            toast.textContent = message;
            toast.classList.add("show");

            setTimeout(() => {
                toast.classList.remove("show");
            }, 3000);
        }

        // Capitalizar texto
        function capitalize(text) {
            return text.charAt(0).toUpperCase() + text.slice(1);
        }
// Filtrar reportes personalizados
function filterCustomReport() {
    const startDate = new Date(document.getElementById("startDate").value);
    const endDate = new Date(document.getElementById("endDate").value);
    
    if (isNaN(startDate) || isNaN(endDate)) {
        showToast("Por favor, selecciona ambas fechas.");
        return;
    }

    if (startDate > endDate) {
        showToast("La fecha de inicio no puede ser mayor que la fecha de fin.");
        return;
    }

    const filteredSales = appState.sales.filter((sale) => {
        const saleDate = new Date(sale.date);
        return saleDate >= startDate && saleDate <= endDate;
    });

    // Actualizar estad√≠sticas
    document.getElementById("totalSales").textContent = filteredSales.length;
    const totalRevenue = filteredSales.reduce((sum, sale) => sum + sale.total, 0);
    document.getElementById("totalRevenue").textContent = `$${totalRevenue}`;

    // Top sabores
    const flavorCounts = {};
    filteredSales.forEach((sale) => {
        Object.entries(sale.items).forEach(([flavorName, qty]) => {
            flavorCounts[flavorName] = (flavorCounts[flavorName] || 0) + qty;
        });
    });

    const topFlavors = Object.entries(flavorCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

    const topFlavorsDiv = document.getElementById("topFlavors");
    topFlavorsDiv.innerHTML = "";

    if (topFlavors.length === 0) {
        topFlavorsDiv.innerHTML = '<div class="empty-state"><p>No hay datos disponibles</p></div>';
    } else {
        topFlavors.forEach(([flavorName, count]) => {
            const item = document.createElement("div");
            item.className = "stock-item";
            const flavorObj = appState.flavors.find((f) => f.name === flavorName);
            item.innerHTML = `
                <span>${capitalize(flavorName)}${flavorObj && flavorObj.premium ? " ‚≠ê" : ""}</span>
                <span style="font-weight: bold; color: #4292e4;">${count} vendidas</span>
            `;
            topFlavorsDiv.appendChild(item);
        });
    }

    renderSalesHistory(filteredSales);
}


        // Inicializar la aplicaci√≥n
        initApp();
    </script>
</body>
</html>
