<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Bolis de Kefir - Punto de Venta</title>
<style>
  /* Reset y estilos base */
  * {
    margin: 0; padding: 0; box-sizing: border-box;
  }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #f0f4f8;
    color: #333;
    overflow-x: hidden;
  }
  .app-container {
    max-width: 480px;
    margin: 0 auto;
    min-height: 100vh;
    background: white;
    position: relative;
  }
  header {
    background: linear-gradient(135deg, #4292e4 0%, #2563eb 100%);
    color: white;
    padding: 1rem;
    text-align: center;
    box-shadow: 0 2px 10px rgba(66, 146, 228, 0.3);
    position: sticky;
    top: 0;
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }
  .header-logo {
    width: 40px;
    height: 40px;
    object-fit: contain;
  }
  .nav-tabs {
    display: flex;
    background: white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    position: sticky;
    top: 60px;
    z-index: 99;
    overflow-x: auto;
  }
  .nav-tab {
    flex: 1;
    padding: 1rem;
    text-align: center;
    cursor: pointer;
    border: none;
    background: white;
    color: #666;
    font-size: 0.9rem;
    transition: all 0.3s;
    white-space: nowrap;
  }
  .nav-tab.active {
    color: #4292e4;
    border-bottom: 3px solid #4292e4;
    font-weight: bold;
  }
  .content {
    padding: 1rem;
    min-height: calc(100vh - 120px);
  }
  .section {
    display: none;
  }
  .section.active {
    display: block;
    animation: fadeIn 0.3s;
  }
  @keyframes fadeIn {
    from {opacity: 0; transform: translateY(10px);}
    to {opacity: 1; transform: translateY(0);}
  }
  .flavor-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
    margin-bottom: 1rem;
  }
  .flavor-card {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border-radius: 12px;
    padding: 1rem;
    text-align: center;
    transition: all 0.3s;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    border: 2px solid transparent;
  }
  .flavor-card.selected {
    background: linear-gradient(135deg, #4292e4 0%, #2563eb 100%);
    color: white;
    transform: scale(1.05);
    border-color: #1e40af;
  }
  .flavor-card.premium {
    background: linear-gradient(135deg, #d4af37 0%, #b8860b 100%);
    color: white;
    border-color: #a67c00;
  }
  .flavor-name {
    font-weight: 600;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
  }
  .flavor-quantity {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    margin-top: 0.5rem;
  }
  .quantity-btn {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    border: none;
    background: rgba(255,255,255,0.3);
    color: inherit;
    font-size: 1.2rem;
    cursor: pointer;
    transition: all 0.3s;
  }
  .quantity-btn:hover {
    background: rgba(255,255,255,0.5);
  }
  .quantity-display {
    font-size: 1.2rem;
    font-weight: bold;
    min-width: 30px;
  }
  .cart-summary {
    background: #f0f7ff;
    border-radius: 12px;
    padding: 1rem;
    margin: 1rem 0;
    box-shadow: 0 2px 5px rgba(66,146,228,0.2);
    border: 1px solid #e3f2fd;
  }
  .cart-item {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px solid #e3f2fd;
  }
  .cart-item:last-child {
    border-bottom: none;
  }
  .total-row {
    display: flex;
    justify-content: space-between;
    font-weight: bold;
    font-size: 1.2rem;
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 2px solid #4292e4;
    color: #4292e4;
  }
  .btn-primary {
    background: linear-gradient(135deg, #4292e4 0%, #2563eb 100%);
    color: white;
    border: none;
    padding: 1rem 2rem;
    border-radius: 25px;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    width: 100%;
    transition: all 0.3s;
    box-shadow: 0 4px 15px rgba(66,146,228,0.3);
  }
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(66,146,228,0.4);
  }
  .btn-secondary {
    background: #e3f2fd;
    color: #1976d2;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 20px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s;
  }
  .btn-secondary:hover {
    background: #bbdefb;
  }
  .date-input,
  input[type='text'],
  select,
  input[type='number'] {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #e3f2fd;
    border-radius: 8px;
    font-size: 1rem;
    margin-bottom: 1rem;
  }
  .date-input:focus,
  input[type='text']:focus,
  select:focus,
  input[type='number']:focus {
    outline: none;
    border-color: #4292e4;
  }
  .stats-card {
    background: linear-gradient(135deg, #4292e4 0%, #2563eb 100%);
    color: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    box-shadow: 0 4px 15px rgba(66,146,228,0.3);
  }
  .stats-value {
    font-size: 2rem;
    font-weight: bold;
    margin: 0.5rem 0;
  }
  .stats-label {
    font-size: 0.9rem;
    opacity: 0.9;
  }
  .report-filters {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
    overflow-x: auto;
    padding-bottom: 0.5rem;
    align-items: center;
  }
  .filter-btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 20px;
    background: #e3f2fd;
    color: #1976d2;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.3s;
  }
  .filter-btn.active {
    background: #4292e4;
    color: white;
  }
  .sales-list {
    max-height: 400px;
    overflow-y: auto;
  }
  .sale-item {
    background: #f0f7ff;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.5rem;
    position: relative;
    border: 1px solid #e3f2fd;
  }
  .sale-date {
    font-size: 0.8rem;
    color: #666;
    margin-bottom: 0.5rem;
  }
  .delete-sale {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: #ff4444;
    color: white;
    border: none;
    border-radius: 50%;
    width: 25px;
    height: 25px;
    cursor: pointer;
    font-size: 0.8rem;
  }
  .edit-sale {
    position: absolute;
    top: 0.5rem;
    right: 35px;
    background: #1976d2;
    color: white;
    border: none;
    border-radius: 50%;
    width: 25px;
    height: 25px;
    cursor: pointer;
    font-size: 0.8rem;
  }
  .modal {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }
  .modal.active {
    display: flex;
  }
  .modal-content {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    max-width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    animation: slideUp 0.3s;
  }
  @keyframes slideUp {
    from {transform: translateY(50px); opacity: 0;}
    to {transform: translateY(0); opacity: 1;}
  }
  .input-group {
    margin-bottom: 1rem;
  }
  .input-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #666;
  }
  #weeklyProfit div {
    margin-bottom: 0.5rem;
    font-weight: 600;
    font-size: 1.1rem;
  }
  /* Stock list */
  #stockList {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  .stock-item {
    background: #f0f7ff;
    border-radius: 12px;
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid #e3f2fd;
  }
  .stock-item span {
    font-weight: 600;
    font-size: 1rem;
  }
  .btn-edit-stock {
    background: #2563eb;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s;
  }
  .btn-edit-stock:hover {
    background: #1e40af;
  }
  /* Receta cards */
  #recetaCards {
    display: block;
    max-height: none;
    overflow-y: visible;
  }
  .receta-card {
    border: 2px solid #4292e4;
    border-radius: 12px;
    padding: 1rem;
    background: #e3f2fd;
  }
  .receta-card h4 {
    margin-bottom: 0.5rem;
    color: #2563eb;
  }
  .receta-input-group {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    flex-wrap: wrap;
  }
  .receta-input-group label {
    flex: 1 0 120px;
    font-weight: 600;
    color: #1976d2;
  }
  .receta-input-group input {
    flex: 1 1 100px;
  }
  /* Selector de sabor para receta */
  #recetaSelector {
    margin-bottom: 1rem;
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #e3f2fd;
    border-radius: 8px;
    font-size: 1rem;
  }
  /* Secci√≥n de deudas en reportes */
  #debtSection {
    margin-top: 2rem;
  }
  #debtSection h3 {
    color: #d32f2f;
    margin-bottom: 1rem;
  }
  .debt-sale-item {
    background: #fdecea;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.5rem;
    position: relative;
    border: 1px solid #f5c6cb;
  }
  .debt-sale-item .sale-date {
    font-size: 0.8rem;
    color: #a94442;
    margin-bottom: 0.5rem;
  }
  .debt-sale-item button {
    margin-left: 0.5rem;
  }
</style>
</head>
<body>
<div class="app-container" role="main">
  <header>
    <div class="header-logo" aria-hidden="true">‚òÅÔ∏è</div>
    <h1>Bolis de Kefir</h1>
  </header>

  <nav class="nav-tabs" role="tablist" aria-label="Navegaci√≥n principal">
    <button class="nav-tab active" role="tab" aria-selected="true" aria-controls="ventas" id="tab-ventas" onclick="showSection('ventas', event)">üõí Ventas</button>
    <button class="nav-tab" role="tab" aria-selected="false" aria-controls="reportes" id="tab-reportes" onclick="showSection('reportes', event)">üìä Reportes</button>
    <button class="nav-tab" role="tab" aria-selected="false" aria-controls="stock" id="tab-stock" onclick="showSection('stock', event)">üì¶ Stock</button>
    <button class="nav-tab" role="tab" aria-selected="false" aria-controls="config" id="tab-config" onclick="showSection('config', event)">‚öôÔ∏è Config</button>
    <button class="nav-tab" role="tab" aria-selected="false" aria-controls="receta" id="tab-receta" onclick="showSection('receta', event)">üìã Receta</button>
  </nav>

  <main class="content">
    <!-- Ventas -->
    <section id="ventas" class="section active" role="tabpanel" aria-labelledby="tab-ventas">
      <div class="input-group">
        <label for="saleDate">Fecha de venta:</label>
        <input type="date" id="saleDate" class="date-input" />
      </div>

      <div class="input-group">
        <label for="clientName">Cliente:</label>
        <input type="text" id="clientName" placeholder="Nombre del cliente (opcional)" />
      </div>

      <div class="input-group">
        <label for="paymentType">Tipo de pago:</label>
        <select id="paymentType" aria-label="Tipo de pago">
          <option value="Efectivo">Efectivo</option>
          <option value="Transferencia">Transferencia</option>
          <option value="Debe">Debe</option>
        </select>
      </div>

      <div class="input-group">
        <label for="freeType">¬øCongelada gratis?</label>
        <select id="freeType" aria-label="Congelada gratis">
          <option value="no">No</option>
          <option value="consumo">Consumo propio</option>
          <option value="regalo">Regalo</option>
        </select>
      </div>

      <h3 style="margin-bottom: 1rem; color: #1976d2;">Selecciona los sabores:</h3>
      <div id="flavorGrid" class="flavor-grid" role="list"></div>

      <div id="cartSummary" class="cart-summary" style="display: none;">
        <h3 style="margin-bottom: 0.5rem; color: #1976d2;">Resumen de venta:</h3>
        <div id="cartItems"></div>
        <div class="total-row">
          <span>Total:</span>
          <span id="totalAmount">$0</span>
        </div>
      </div>

      <button class="btn-primary" onclick="completeSale()">Completar Venta</button>
    </section>

    <!-- Reportes -->
    <section id="reportes" class="section" role="tabpanel" aria-labelledby="tab-reportes">
      <div class="report-filters">
        <button class="filter-btn active" onclick="filterReport('today', event)">D√≠a en curso</button>
        <input type="date" id="reportStartDate" aria-label="Fecha inicio reporte" />
        <input type="date" id="reportEndDate" aria-label="Fecha fin reporte" />
        <button class="btn-secondary" onclick="filterReport('custom')">Filtrar</button>
      </div>

      <div class="stats-card" aria-live="polite" aria-atomic="true">
        <div class="stats-label">Ventas totales</div>
        <div class="stats-value" id="totalSales">0</div>
      </div>

      <div class="stats-card" aria-live="polite" aria-atomic="true">
        <div class="stats-label">Total congeladas vendidas</div>
        <div class="stats-value" id="totalUnitsSold">0</div>
      </div>

      <div class="stats-card" aria-live="polite" aria-atomic="true">
        <div class="stats-label">Ingresos totales</div>
        <div class="stats-value" id="totalRevenue">$0</div>
      </div>

      <h3 style="margin: 1rem 0; color: #1976d2;">Sabores m√°s vendidos:</h3>
      <div id="topFlavors"></div>

      <h3 style="margin: 1rem 0; color: #1976d2;">Ganancia Semanal</h3>
      <div id="weeklyProfit" class="stats-card" style="background: linear-gradient(135deg, #43a047 0%, #2e7d32 100%); color: white;">
        <div><strong>Reparto (10%):</strong> <span id="profitReparto">$0</span></div>
        <div><strong>Crecimiento (20%):</strong> <span id="profitGrowth">$0</span></div>
        <div><strong>Reinversi√≥n (50%):</strong> <span id="profitReinvestment">$0</span></div>
        <div><strong>Ganancia (20%):</strong> <span id="profitGain">$0</span></div>
      </div>

      <h3 style="margin: 1rem 0; color: #1976d2;">Historial de ventas:</h3>
      <div id="salesHistory" class="sales-list" role="list"></div>

      <h3 id="debtSectionTitle" style="margin-top: 2rem; color: #d32f2f;">Ventas con Deuda (Debe)</h3>
      <div id="debtSection" class="sales-list" role="list"></div>

      <button class="btn-primary" onclick="exportReport()">üì• Exportar Reporte</button>
    </section>

    <!-- Stock -->
    <section id="stock" class="section" role="tabpanel" aria-labelledby="tab-stock">
      <h3 style="margin-bottom: 1rem; color: #1976d2;">Control de inventario:</h3>
      <div id="stockList"></div>
    </section>

    <!-- Config -->
    <section id="config" class="section" role="tabpanel" aria-labelledby="tab-config">
      <h3 style="margin-bottom: 1rem; color: #1976d2;">Configuraci√≥n:</h3>

      <div style="margin-bottom: 2rem;">
        <h4 style="margin-bottom: 0.5rem; color: #1976d2;">Agregar nuevo sabor:</h4>
        <div class="input-group">
          <input type="text" id="newFlavorName" placeholder="Nombre del sabor" />
        </div>
        <button class="btn-secondary" onclick="addNewFlavor()">+ Agregar Sabor</button>
      </div>

      <div style="margin-bottom: 2rem;">
        <h4 style="margin-bottom: 0.5rem; color: #1976d2;">Marcar sabores premium:</h4>
        <div id="premiumFlavorsList"></div>
      </div>

      <div style="margin-bottom: 2rem;">
        <h4 style="margin-bottom: 0.5rem; color: #1976d2;">Costos de producci√≥n:</h4>
        <button class="btn-secondary" onclick="showCostModal()">üí∞ Gestionar Costos</button>
      </div>

      <div style="margin-bottom: 2rem;">
        <h4 style="margin-bottom: 0.5rem; color: #1976d2;">Informaci√≥n del sistema:</h4>
        <p style="color: #666; font-size: 0.9rem;">Versi√≥n 1.0 - PWA habilitada</p>
        <p style="color: #666; font-size: 0.9rem;">Datos almacenados localmente</p>
      </div>
    </section>

    <!-- Receta -->
    <section id="receta" class="section" role="tabpanel" aria-labelledby="tab-receta">
      <h3 style="margin-bottom: 1rem; color: #1976d2;">Gesti√≥n de Receta</h3>
      <select id="recetaSelector" aria-label="Seleccionar sabor para receta" onchange="renderRecetaCards()"></select>
      <div id="recetaCards"></div>
      <button class="btn-primary" onclick="guardarRecetas()">Guardar Recetas</button>
    </section>
  </main>
</div>

<!-- Modal para editar stock -->
<div id="stockModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="stockModalTitle">
  <div class="modal-content">
    <h3 id="stockModalTitle" style="margin-bottom: 1rem; color: #1976d2;">Editar Stock</h3>
    <div id="stockModalContent"></div>
    <button class="btn-primary" onclick="guardarStockModal()">Guardar</button>
    <button class="btn-secondary" onclick="cerrarStockModal()">Cancelar</button>
  </div>
</div>

<!-- Modal para gestionar costos -->
<div id="costModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="costModalTitle">
  <div class="modal-content">
    <h3 id="costModalTitle" style="margin-bottom: 1rem; color: #1976d2;">Gesti√≥n de costos</h3>
    <div id="costList"></div>
    <button class="btn-primary" onclick="closeCostModal()">Cerrar</button>
  </div>
</div>

<!-- Modal para editar venta -->
<div id="editSaleModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="editSaleModalTitle">
  <div class="modal-content">
    <h3 id="editSaleModalTitle" style="margin-bottom: 1rem; color: #1976d2;">Editar Venta</h3>
    <form id="editSaleForm">
      <div class="input-group">
        <label for="editSaleDate">Fecha de venta:</label>
        <input type="date" id="editSaleDate" required />
      </div>
      <div class="input-group">
        <label for="editClientName">Cliente:</label>
        <input type="text" id="editClientName" />
      </div>
      <div class="input-group">
        <label for="editPaymentType">Tipo de pago:</label>
        <select id="editPaymentType" required>
          <option value="Efectivo">Efectivo</option>
          <option value="Transferencia">Transferencia</option>
          <option value="Debe">Debe</option>
          <option value="Gratis (consumo)">Gratis (consumo)</option>
          <option value="Gratis (regalo)">Gratis (regalo)</option>
        </select>
      </div>
      <div class="input-group">
        <label>Sabores y cantidades:</label>
        <div id="editSaleFlavors"></div>
      </div>
      <button type="submit" class="btn-primary">Guardar Cambios</button>
      <button type="button" class="btn-secondary" onclick="closeEditSaleModal()">Cancelar</button>
    </form>
  </div>
</div>

<div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true"></div>

<script>
  let appState = {
    flavors: [
      'cereza',
      'chocolate hershey',
      'chocolate abuelita',
      'ciruela',
      'coco',
      'durazno',
      'fresa',
      'fresa con nutella',
      'guayaba',
      'mamey',
      'mango',
      'mazap√°n',
      'nuez',
      'oreo',
      'pi√±√≥n',
      'pistache',
    ],
    cart: {},
    sales: [],
    stock: {},
    costs: {},
    premiumFlavors: [],
    currentFilter: 'today',
    recetaPorSabor: {},
  };

  let editingSaleId = null;

  function initApp() {
    loadData();
    setDefaultDate();
    setDefaultReportDates();
    renderFlavors();
    renderStock();
    updateReports();
    renderPremiumFlavors();
    populateRecetaSelector();
    renderRecetaCards();
  }

  function loadData() {
    const savedData = localStorage.getItem('congeladasApp');
    if (savedData) {
      try {
        const parsed = JSON.parse(savedData);
        // Merge carefully to avoid overwriting entire appState
        appState.flavors = parsed.flavors || appState.flavors;
        appState.cart = parsed.cart || {};
        appState.sales = parsed.sales || [];
        appState.stock = parsed.stock || {};
        appState.costs = parsed.costs || {};
        appState.premiumFlavors = parsed.premiumFlavors || [];
        appState.currentFilter = parsed.currentFilter || 'today';
        appState.recetaPorSabor = parsed.recetaPorSabor || {};
      } catch (e) {
        console.error('Error parsing saved data:', e);
      }
    }

    // Initialize stock, costs, recetaPorSabor for any new flavors
    appState.flavors.forEach(flavor => {
      if (appState.stock[flavor] === undefined) appState.stock[flavor] = 50;
      if (appState.costs[flavor] === undefined) appState.costs[flavor] = 10;
      if (appState.recetaPorSabor[flavor] === undefined) {
        appState.recetaPorSabor[flavor] = {
          frutoCantidad: 0,
          frutoCosto: 0,
          kefirCantidad: 0,
          kefirCosto: 0,
          lecheraCantidad: 0,
          lecheraCosto: 0,
          saborizanteCantidad: 0,
          saborizanteCosto: 0,
          trozosCantidad: 0,
          trozosCosto: 0,
          bolsasCantidad: 1,
          otrosCantidad: 0,
          otrosCosto: 0,
          costoUnitario: 0,
        };
      }
    });
  }

  function saveData() {
    localStorage.setItem('congeladasApp', JSON.stringify(appState));
  }

  // Ajuste para zona horaria GMT+6 en setDefaultDate
  function setDefaultDate() {
    const now = new Date();
    const gmt6Offset = 6 * 60; // minutos
    const localTime = new Date(now.getTime() + (gmt6Offset + now.getTimezoneOffset()) * 60000);
    const today = localTime.toISOString().split('T')[0];
    document.getElementById('saleDate').value = today;
  }

  // Ajuste para zona horaria GMT+6 en formatDate
  function formatDate(dateStr) {
    const date = new Date(dateStr);
    const gmt6Offset = 6 * 60; // minutos
    const localTime = new Date(date.getTime() + (gmt6Offset + date.getTimezoneOffset()) * 60000);
    return localTime.toLocaleDateString('es-MX', { year: 'numeric', month: 'long', day: 'numeric' });
  }

  function setDefaultReportDates() {
    const now = new Date();
    const gmt6Offset = 6 * 60; // minutos
    const localTime = new Date(now.getTime() + (gmt6Offset + now.getTimezoneOffset()) * 60000);
    const today = localTime.toISOString().split('T')[0];
    document.getElementById('reportStartDate').value = today;
    document.getElementById('reportEndDate').value = today;
  }

  function showSection(sectionId, event) {
    document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.classList.remove('active');
      tab.setAttribute('aria-selected', 'false');
    });

    document.getElementById(sectionId).classList.add('active');
    if (event) {
      event.currentTarget.classList.add('active');
      event.currentTarget.setAttribute('aria-selected', 'true');
    }

    if (sectionId === 'reportes') updateReports();
    if (sectionId === 'config') renderPremiumFlavors();
  }

  // Renderizar sabores en ventas
  function renderFlavors() {
    const container = document.getElementById('flavorGrid');
    container.innerHTML = '';
    appState.flavors.forEach(flavor => {
      const card = document.createElement('div');
      card.className = 'flavor-card';
      if (appState.premiumFlavors.includes(flavor)) card.classList.add('premium');
      card.setAttribute('role', 'listitem');
      card.setAttribute('tabindex', '0');
      card.setAttribute('aria-label', `Sabor ${flavor}`);

      const name = document.createElement('div');
      name.className = 'flavor-name';
      name.textContent = flavor;

      const quantityDiv = document.createElement('div');
      quantityDiv.className = 'flavor-quantity';

      const btnMinus = document.createElement('button');
      btnMinus.className = 'quantity-btn';
      btnMinus.textContent = '-';
      btnMinus.setAttribute('aria-label', `Disminuir cantidad de ${flavor}`);
      btnMinus.onclick = () => changeFlavorQuantity(flavor, -1);

      const quantityDisplay = document.createElement('div');
      quantityDisplay.className = 'quantity-display';
      quantityDisplay.id = `qty-${flavor}`;
      quantityDisplay.textContent = appState.cart[flavor] || 0;

      const btnPlus = document.createElement('button');
      btnPlus.className = 'quantity-btn';
      btnPlus.textContent = '+';
      btnPlus.setAttribute('aria-label', `Aumentar cantidad de ${flavor}`);
      btnPlus.onclick = () => changeFlavorQuantity(flavor, 1);

      quantityDiv.appendChild(btnMinus);
      quantityDiv.appendChild(quantityDisplay);
      quantityDiv.appendChild(btnPlus);

      card.appendChild(name);
      card.appendChild(quantityDiv);

      container.appendChild(card);
    });
    updateCartSummary();
  }

  function changeFlavorQuantity(flavor, delta) {
    const currentQty = appState.cart[flavor] || 0;
    const newQty = currentQty + delta;
    if (newQty < 0) return;
    appState.cart[flavor] = newQty;
    if (newQty === 0) delete appState.cart[flavor];
    document.getElementById(`qty-${flavor}`).textContent = newQty;
    updateCartSummary();
  }

  function updateCartSummary() {
    const cartItemsDiv = document.getElementById('cartItems');
    const cartSummary = document.getElementById('cartSummary');
    cartItemsDiv.innerHTML = '';
    let total = 0;
    const costs = appState.costs;
    for (const flavor in appState.cart) {
      const qty = appState.cart[flavor];
      const cost = costs[flavor] !== undefined ? costs[flavor] : 10;
      const itemTotal = qty * cost;
      total += itemTotal;

      const itemDiv = document.createElement('div');
      itemDiv.className = 'cart-item';
      itemDiv.textContent = `${flavor}: ${qty} x $${cost.toFixed(2)} = $${itemTotal.toFixed(2)}`;
      cartItemsDiv.appendChild(itemDiv);
    }
    if (total > 0) {
      cartSummary.style.display = 'block';
      document.getElementById('totalAmount').textContent = `$${total.toFixed(2)}`;
    } else {
      cartSummary.style.display = 'none';
    }
  }

  function completeSale() {
    const date = document.getElementById('saleDate').value;
    if (!date) {
      alert('Por favor selecciona una fecha v√°lida.');
      return;
    }
    if (Object.keys(appState.cart).length === 0) {
      alert('Selecciona al menos un sabor para la venta.');
      return;
    }
    const client = document.getElementById('clientName').value.trim();
    const paymentType = document.getElementById('paymentType').value;
    const freeType = document.getElementById('freeType').value;

    // Construir objeto venta
    const sale = {
      id: Date.now(),
      date,
      client,
      paymentType: freeType === 'no' ? paymentType : `Gratis (${freeType})`,
      flavors: { ...appState.cart },
    };

    appState.sales.push(sale);

    // Actualizar stock
    for (const flavor in appState.cart) {
      const qty = appState.cart[flavor];
      appState.stock[flavor] = (appState.stock[flavor] || 0) - qty;
      if (appState.stock[flavor] < 0) appState.stock[flavor] = 0;
    }

    // Limpiar carrito y campos
    appState.cart = {};
    document.getElementById('clientName').value = '';
    document.getElementById('paymentType').value = 'Efectivo';
    document.getElementById('freeType').value = 'no';
    setDefaultDate();
    renderFlavors();
    renderStock();
    updateReports();
    saveData();
    alert('Venta registrada correctamente.');
  }

  // Reportes

  function filterReport(filterType, event) {
    if (event) {
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      if (filterType !== 'custom') event.currentTarget.classList.add('active');
    }
    appState.currentFilter = filterType;
    updateReports();
  }

  function updateReports() {
    let filteredSales = [];
    const now = new Date();
    const gmt6Offset = 6 * 60;
    const localNow = new Date(now.getTime() + (gmt6Offset + now.getTimezoneOffset()) * 60000);

    if (appState.currentFilter === 'today') {
      const todayStr = localNow.toISOString().split('T')[0];
      filteredSales = appState.sales.filter(sale => sale.date === todayStr);
      document.getElementById('reportStartDate').value = todayStr;
      document.getElementById('reportEndDate').value = todayStr;
    } else if (appState.currentFilter === 'custom') {
      const start = document.getElementById('reportStartDate').value;
      const end = document.getElementById('reportEndDate').value;
      if (!start || !end) {
        alert('Selecciona fechas v√°lidas para filtrar.');
        return;
      }
      filteredSales = appState.sales.filter(sale => sale.date >= start && sale.date <= end);
    }

    // Mostrar ventas con deuda siempre
    const debtSales = appState.sales.filter(sale => sale.paymentType === 'Debe');

    // Estad√≠sticas
    const totalSales = filteredSales.length;
    let totalUnits = 0;
    let totalRevenue = 0;
    const flavorCount = {};

    filteredSales.forEach(sale => {
      for (const flavor in sale.flavors) {
        const qty = sale.flavors[flavor];
        totalUnits += qty;
        const cost = appState.costs[flavor] !== undefined ? appState.costs[flavor] : 10;
        if (!sale.paymentType.toLowerCase().includes('gratis')) {
          totalRevenue += qty * cost;
        }
        flavorCount[flavor] = (flavorCount[flavor] || 0) + qty;
      }
    });

    // Top sabores
    const topFlavors = Object.entries(flavorCount)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5);

    // Mostrar estad√≠sticas
    document.getElementById('totalSales').textContent = totalSales;
    document.getElementById('totalUnitsSold').textContent = totalUnits;
    document.getElementById('totalRevenue').textContent = `$${totalRevenue.toFixed(2)}`;

    // Mostrar top sabores
    const topFlavorsDiv = document.getElementById('topFlavors');
    topFlavorsDiv.innerHTML = '';
    if (topFlavors.length === 0) {
      topFlavorsDiv.textContent = 'No hay ventas para mostrar.';
    } else {
      topFlavors.forEach(([flavor, qty]) => {
        const div = document.createElement('div');
        div.textContent = `${flavor}: ${qty}`;
        topFlavorsDiv.appendChild(div);
      });
    }

    // Ganancia semanal (simplificada)
    const reparto = totalRevenue * 0.1;
    const crecimiento = totalRevenue * 0.2;
    const reinversion = totalRevenue * 0.5;
    const ganancia = totalRevenue * 0.2;

    document.getElementById('profitReparto').textContent = `$${reparto.toFixed(2)}`;
    document.getElementById('profitGrowth').textContent = `$${crecimiento.toFixed(2)}`;
    document.getElementById('profitReinvestment').textContent = `$${reinversion.toFixed(2)}`;
    document.getElementById('profitGain').textContent = `$${ganancia.toFixed(2)}`;

    // Mostrar historial ventas filtradas
    renderSalesHistory(filteredSales);

    // Mostrar ventas con deuda siempre
    renderDebtSales(debtSales);
  }

  function renderSalesHistory(sales) {
    const container = document.getElementById('salesHistory');
    container.innerHTML = '';
    if (sales.length === 0) {
      container.textContent = 'No hay ventas para mostrar.';
      return;
    }
    sales.forEach(sale => {
      const div = document.createElement('div');
      div.className = 'sale-item';
      div.setAttribute('role', 'listitem');
      const dateFormatted = formatDate(sale.date);
      div.innerHTML = `
        <div class="sale-date">${dateFormatted}</div>
        <div><strong>Cliente:</strong> ${sale.client || 'N/A'}</div>
        <div><strong>Pago:</strong> ${sale.paymentType}</div>
        <div><strong>Sabores:</strong> ${Object.entries(sale.flavors).map(([f, q]) => `${f} (${q})`).join(', ')}</div>
        <button class="edit-sale" aria-label="Editar venta" title="Editar venta" onclick="openEditSaleModal(${sale.id})">‚úèÔ∏è</button>
        <button class="delete-sale" aria-label="Eliminar venta" title="Eliminar venta" onclick="deleteSale(${sale.id})">üóëÔ∏è</button>
      `;
      container.appendChild(div);
    });
  }

  function renderDebtSales(sales) {
    const container = document.getElementById('debtSection');
    container.innerHTML = '';
    if (sales.length === 0) {
      container.textContent = 'No hay ventas con deuda.';
      return;
    }
    sales.forEach(sale => {
      const div = document.createElement('div');
      div.className = 'debt-sale-item';
      div.setAttribute('role', 'listitem');
      const dateFormatted = formatDate(sale.date);
      div.innerHTML = `
        <div class="sale-date">${dateFormatted}</div>
        <div><strong>Cliente:</strong> ${sale.client || 'N/A'}</div>
        <div><strong>Pago:</strong> ${sale.paymentType}</div>
        <div><strong>Sabores:</strong> ${Object.entries(sale.flavors).map(([f, q]) => `${f} (${q})`).join(', ')}</div>
        <button class="edit-sale" aria-label="Editar venta con deuda" title="Editar venta" onclick="openEditSaleModal(${sale.id})">‚úèÔ∏è</button>
        <button class="delete-sale" aria-label="Eliminar venta con deuda" title="Eliminar venta" onclick="deleteSale(${sale.id})">üóëÔ∏è</button>
      `;
      container.appendChild(div);
    });
  }

  function deleteSale(id) {
    if (!confirm('¬øSeguro que quieres eliminar esta venta?')) return;
    appState.sales = appState.sales.filter(sale => sale.id !== id);
    saveData();
    updateReports();
    renderStock();
  }

  // Modal edici√≥n venta
  function openEditSaleModal(id) {
    editingSaleId = id;
    const sale = appState.sales.find(s => s.id === id);
    if (!sale) return alert('Venta no encontrada.');

    document.getElementById('editSaleDate').value = sale.date;
    document.getElementById('editClientName').value = sale.client || '';
    document.getElementById('editPaymentType').value = sale.paymentType;

    const flavorsDiv = document.getElementById('editSaleFlavors');
    flavorsDiv.innerHTML = '';
    appState.flavors.forEach(flavor => {
      const qty = sale.flavors[flavor] || 0;
      const group = document.createElement('div');
      group.className = 'input-group';
      group.style.display = 'flex';
      group.style.alignItems = 'center';
      group.style.gap = '0.5rem';

      const label = document.createElement('label');
      label.textContent = flavor;
      label.style.flex = '1 0 120px';

      const input = document.createElement('input');
      input.type = 'number';
      input.min = 0;
      input.value = qty;
      input.dataset.flavor = flavor;
      input.style.flex = '1 1 60px';

      group.appendChild(label);
      group.appendChild(input);
      flavorsDiv.appendChild(group);
    });

    document.getElementById('editSaleModal').classList.add('active');
  }

  function closeEditSaleModal() {
    editingSaleId = null;
    document.getElementById('editSaleModal').classList.remove('active');
  }

  document.getElementById('editSaleForm').addEventListener('submit', function(e) {
    e.preventDefault();
    if (editingSaleId === null) return;

    const date = document.getElementById('editSaleDate').value;
    if (!date) return alert('Fecha inv√°lida.');

    const client = document.getElementById('editClientName').value.trim();
    const paymentType = document.getElementById('editPaymentType').value;

    const flavorsInputs = document.querySelectorAll('#editSaleFlavors input');
    const flavors = {};
    flavorsInputs.forEach(input => {
      const qty = parseInt(input.value) || 0;
      if (qty > 0) flavors[input.dataset.flavor] = qty;
    });

    if (Object.keys(flavors).length === 0) {
      alert('Debe haber al menos un sabor con cantidad mayor a cero.');
      return;
    }

    // Para stock, revertir cantidades anteriores
    const oldSaleIndex = appState.sales.findIndex(s => s.id === editingSaleId);
    if (oldSaleIndex === -1) return alert('Venta no encontrada.');

    const oldSale = appState.sales[oldSaleIndex];
    for (const flavor in oldSale.flavors) {
      appState.stock[flavor] = (appState.stock[flavor] || 0) + oldSale.flavors[flavor];
    }

    // Actualizar datos
    appState.sales[oldSaleIndex] = {
      id: editingSaleId,
      date,
      client,
      paymentType,
      flavors,
    };

    // Actualizar stock con nuevos valores
    for (const flavor in flavors) {
      appState.stock[flavor] = (appState.stock[flavor] || 0) - flavors[flavor];
      if (appState.stock[flavor] < 0) appState.stock[flavor] = 0;
    }

    saveData();
    updateReports();
    renderStock();
    closeEditSaleModal();
    alert('Venta actualizada correctamente.');
  });

  // Stock
  function renderStock() {
    const container = document.getElementById('stockList');
    container.innerHTML = '';
    appState.flavors.forEach(flavor => {
      const div = document.createElement('div');
      div.className = 'stock-item';
      div.innerHTML = `
        <span>${flavor}</span>
        <span>${appState.stock[flavor] || 0}</span>
        <button class="btn-edit-stock" aria-label="Editar stock de ${flavor}" onclick="openStockModal('${flavor}')">Editar</button>
      `;
      container.appendChild(div);
    });
  }

  let editingStockFlavor = null;

  function openStockModal(flavor) {
    editingStockFlavor = flavor;
    const modal = document.getElementById('stockModal');
    const content = document.getElementById('stockModalContent');
    content.innerHTML = `
      <label for="stockInput">Stock para ${flavor}:</label>
      <input type="number" id="stockInput" min="0" value="${appState.stock[flavor] || 0}" />
    `;
    modal.classList.add('active');
  }

  function guardarStockModal() {
    const input = document.getElementById('stockInput');
    const val = parseInt(input.value);
    if (isNaN(val) || val < 0) {
      alert('Cantidad inv√°lida');
      return;
    }
    appState.stock[editingStockFlavor] = val;
    saveData();
    renderStock();
    document.getElementById('stockModal').classList.remove('active');
  }

  function cerrarStockModal() {
    document.getElementById('stockModal').classList.remove('active');
  }

  // Configuraci√≥n premium sabores
  function renderPremiumFlavors() {
    const container = document.getElementById('premiumFlavorsList');
    container.innerHTML = '';
    appState.flavors.forEach(flavor => {
      const div = document.createElement('div');
      div.style.marginBottom = '0.5rem';
      const checked = appState.premiumFlavors.includes(flavor) ? 'checked' : '';
      div.innerHTML = `
        <label>
          <input type="checkbox" data-flavor="${flavor}" ${checked} onchange="togglePremiumFlavor(event)" />
          ${flavor}
        </label>
      `;
      container.appendChild(div);
    });
  }

  function togglePremiumFlavor(event) {
    const flavor = event.target.dataset.flavor;
    if (event.target.checked) {
      if (!appState.premiumFlavors.includes(flavor)) {
        appState.premiumFlavors.push(flavor);
      }
    } else {
      appState.premiumFlavors = appState.premiumFlavors.filter(f => f !== flavor);
    }
    saveData();
    renderFlavors();
  }

  function addNewFlavor() {
    const input = document.getElementById('newFlavorName');
    const newFlavor = input.value.trim().toLowerCase();
    if (!newFlavor) {
      alert('Ingresa un nombre v√°lido para el sabor.');
      return;
    }
    if (appState.flavors.includes(newFlavor)) {
      alert('El sabor ya existe.');
      return;
    }
    appState.flavors.push(newFlavor);
    appState.stock[newFlavor] = 50;
    appState.costs[newFlavor] = 10;
    appState.recetaPorSabor[newFlavor] = {
      frutoCantidad: 0,
      frutoCosto: 0,
      kefirCantidad: 0,
      kefirCosto: 0,
      lecheraCantidad: 0,
      lecheraCosto: 0,
      saborizanteCantidad: 0,
      saborizanteCosto: 0,
      trozosCantidad: 0,
      trozosCosto: 0,
      bolsasCantidad: 1,
      otrosCantidad: 0,
      otrosCosto: 0,
      costoUnitario: 0,
    };
    input.value = '';
    saveData();
    renderFlavors();
    renderStock();
    renderPremiumFlavors();
    populateRecetaSelector();
    renderRecetaCards();
  }

  // Costos
  function showCostModal() {
    const container = document.getElementById('costList');
    container.innerHTML = '';
    appState.flavors.forEach(flavor => {
      const div = document.createElement('div');
      div.className = 'input-group';
      div.innerHTML = `
        <label for="cost-${flavor}">${flavor}:</label>
        <input type="number" id="cost-${flavor}" min="0" step="0.01" value="${appState.costs[flavor] !== undefined ? appState.costs[flavor] : 10}" />
      `;
      container.appendChild(div);
    });
    document.getElementById('costModal').classList.add('active');
  }

  function closeCostModal() {
    // Guardar costos
    appState.flavors.forEach(flavor => {
      const input = document.getElementById(`cost-${flavor}`);
      if (input) {
        const val = parseFloat(input.value);
        if (!isNaN(val) && val >= 0) {
          appState.costs[flavor] = val;
        }
      }
    });
    saveData();
    updateReports();
    document.getElementById('costModal').classList.remove('active');
  }

  // Receta

  function populateRecetaSelector() {
    const selector = document.getElementById('recetaSelector');
    selector.innerHTML = '';
    appState.flavors.forEach(flavor => {
      const option = document.createElement('option');
      option.value = flavor;
      option.textContent = flavor;
      selector.appendChild(option);
    });
  }

  function renderRecetaCards() {
    const selector = document.getElementById('recetaSelector');
    const selectedFlavor = selector.value;
    const container = document.getElementById('recetaCards');
    container.innerHTML = '';
    if (!selectedFlavor) return;

    const receta = appState.recetaPorSabor[selectedFlavor];
    if (!receta) return;

    const card = document.createElement('div');
    card.className = 'receta-card';

    card.innerHTML = `
      <h4>Receta para ${selectedFlavor}</h4>
      <div class="receta-input-group">
        <label for="frutoCantidad">Fruto (cantidad):</label>
        <input type="number" id="frutoCantidad" min="0" step="0.01" value="${receta.frutoCantidad}" />
        <label for="frutoCosto">Fruto (costo):</label>
        <input type="number" id="frutoCosto" min="0" step="0.01" value="${receta.frutoCosto}" />
      </div>
      <div class="receta-input-group">
        <label for="kefirCantidad">Kefir (cantidad):</label>
        <input type="number" id="kefirCantidad" min="0" step="0.01" value="${receta.kefirCantidad}" />
        <label for="kefirCosto">Kefir (costo):</label>
        <input type="number" id="kefirCosto" min="0" step="0.01" value="${receta.kefirCosto}" />
      </div>
      <div class="receta-input-group">
        <label for="lecheraCantidad">Lechera (cantidad):</label>
        <input type="number" id="lecheraCantidad" min="0" step="0.01" value="${receta.lecheraCantidad}" />
        <label for="lecheraCosto">Lechera (costo):</label>
        <input type="number" id="lecheraCosto" min="0" step="0.01" value="${receta.lecheraCosto}" />
      </div>
      <div class="receta-input-group">
        <label for="saborizanteCantidad">Saborizante (cantidad):</label>
        <input type="number" id="saborizanteCantidad" min="0" step="0.01" value="${receta.saborizanteCantidad}" />
        <label for="saborizanteCosto">Saborizante (costo):</label>
        <input type="number" id="saborizanteCosto" min="0" step="0.01" value="${receta.saborizanteCosto}" />
      </div>
      <div class="receta-input-group">
        <label for="trozosCantidad">Trozos (cantidad):</label>
        <input type="number" id="trozosCantidad" min="0" step="0.01" value="${receta.trozosCantidad}" />
        <label for="trozosCosto">Trozos (costo):</label>
        <input type="number" id="trozosCosto" min="0" step="0.01" value="${receta.trozosCosto}" />
      </div>
      <div class="receta-input-group">
        <label for="bolsasCantidad">Bolsas (cantidad):</label>
        <input type="number" id="bolsasCantidad" min="0" step="1" value="${receta.bolsasCantidad}" />
      </div>
      <div class="receta-input-group">
        <label for="otrosCantidad">Otros (cantidad):</label>
        <input type="number" id="otrosCantidad" min="0" step="0.01" value="${receta.otrosCantidad}" />
        <label for="otrosCosto">Otros (costo):</label>
        <input type="number" id="otrosCosto" min="0" step="0.01" value="${receta.otrosCosto}" />
      </div>
      <div class="receta-input-group">
        <label for="costoUnitario">Costo unitario:</label>
        <input type="number" id="costoUnitario" min="0" step="0.01" value="${receta.costoUnitario}" />
      </div>
    `;

    container.appendChild(card);
  }

  function guardarRecetas() {
    const selector = document.getElementById('recetaSelector');
    const selectedFlavor = selector.value;
    if (!selectedFlavor) return alert('Selecciona un sabor para guardar la receta.');

    const receta = {
      frutoCantidad: parseFloat(document.getElementById('frutoCantidad').value) || 0,
      frutoCosto: parseFloat(document.getElementById('frutoCosto').value) || 0,
      kefirCantidad: parseFloat(document.getElementById('kefirCantidad').value) || 0,
      kefirCosto: parseFloat(document.getElementById('kefirCosto').value) || 0,
      lecheraCantidad: parseFloat(document.getElementById('lecheraCantidad').value) || 0,
      lecheraCosto: parseFloat(document.getElementById('lecheraCosto').value) || 0,
      saborizanteCantidad: parseFloat(document.getElementById('saborizanteCantidad').value) || 0,
      saborizanteCosto: parseFloat(document.getElementById('saborizanteCosto').value) || 0,
      trozosCantidad: parseFloat(document.getElementById('trozosCantidad').value) || 0,
      trozosCosto: parseFloat(document.getElementById('trozosCosto').value) || 0,
      bolsasCantidad: parseInt(document.getElementById('bolsasCantidad').value) || 1,
      otrosCantidad: parseFloat(document.getElementById('otrosCantidad').value) || 0,
      otrosCosto: parseFloat(document.getElementById('otrosCosto').value) || 0,
      costoUnitario: parseFloat(document.getElementById('costoUnitario').value) || 0,
    };

    appState.recetaPorSabor[selectedFlavor] = receta;
    saveData();
    alert('Receta guardada correctamente.');
  }

  // Exportar reporte (simple CSV)
  function exportReport() {
    let csv = 'Fecha,Cliente,Tipo de pago,Sabores\n';
    appState.sales.forEach(sale => {
      const flavorsStr = Object.entries(sale.flavors).map(([f, q]) => `${f}(${q})`).join('; ');
      csv += `${sale.date},${sale.client || ''},${sale.paymentType},${flavorsStr}\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'reporte_ventas.csv';
    a.click();
    URL.revokeObjectURL(url);
  }

  // Inicializar app
  initApp();
</script>
</body>
</html>
